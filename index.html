<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia CRECE v3</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS para leer Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --secondary: #004E89;
            --accent: #FFA07A;
            --success: #06D6A0;
            --warning: #FFD23F;
            --danger: #EF476F;
            --dark: #1A1A2E;
            --light: #F7F7F9;
            --gray: #8B8C9E;
            --white: #FFFFFF;
            --shadow: rgba(0, 78, 137, 0.1);
            --radius: 12px;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #F0F0F5;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--gray);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #F0F0F5;
            color: var(--dark);
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .login-card {
            background: var(--white);
            border-radius: 24px;
            padding: 3rem;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--gray);
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #E8E8F0;
            border-radius: var(--radius);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--radius);
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(255, 107, 53, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: #003D6E;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
            font-size: 1.1rem;
            padding: 1.25rem 3rem;
        }

        .btn-success:hover {
            background: #05B888;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 214, 160, 0.4);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-danger:hover {
            background: #D63757;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Dashboard */
        .dashboard {
            animation: fadeIn 0.5s ease;
        }

        .dashboard-header {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h2 {
            font-size: 1.75rem;
            color: var(--secondary);
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-badge {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: var(--white);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px var(--shadow);
            animation: slideUp 0.5s ease;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #F0F0F5;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--secondary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #E8E8F0;
            overflow-x: auto;
        }

        .tab {
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--gray);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        thead {
            background: linear-gradient(135deg, var(--secondary), #003D6E);
            color: var(--white);
        }

        thead th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #F0F0F5;
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: #F7F9FC;
        }

        tbody td {
            padding: 1rem;
            color: var(--dark);
        }

        /* Groups Display */
        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .group-card {
            background: var(--white);
            border: 2px solid #E8E8F0;
            border-radius: var(--radius);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .group-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .group-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--secondary);
        }

        .group-distrito {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .asignatura-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: var(--white);
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* File Upload */
        .file-upload {
            border: 3px dashed #D0D0E0;
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #FAFBFC;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: #FFF5F2;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Attendance Grid */
        .attendance-grid {
            display: grid;
            gap: 0.75rem;
        }

        .attendance-row {
            background: #F7F9FC;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            display: grid;
            grid-template-columns: 50px 1fr auto auto;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .attendance-row:hover {
            background: #EDF2F7;
            border-left-color: var(--primary);
        }

        .attendance-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--secondary);
            text-align: center;
        }

        .participant-info {
            font-weight: 500;
        }

        .participant-center {
            color: var(--gray);
            font-size: 0.85rem;
        }

        /* Checkbox Toggle */
        .checkbox-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .checkbox-toggle input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-toggle label {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
            cursor: pointer;
        }

        /* Radio Toggle */
        .radio-group {
            display: flex;
            gap: 1.5rem;
            padding: 1rem;
            background: #F7F9FC;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            border: 2px solid var(--warning);
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--success), #05B888);
            color: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(6, 214, 160, 0.3);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Alert */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-info {
            background: #E3F2FD;
            color: #0D47A1;
            border-left: 4px solid #2196F3;
        }

        .alert-success {
            background: #E8F5E9;
            color: #1B5E20;
            border-left: 4px solid #4CAF50;
        }

        .alert-warning {
            background: #FFF3E0;
            color: #E65100;
            border-left: 4px solid #FF9800;
        }

        .alert-danger {
            background: #FFEBEE;
            color: #B71C1C;
            border-left: 4px solid #F44336;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-presencial {
            background: #E3F2FD;
            color: #1565C0;
        }

        .badge-virtual {
            background: #F3E5F5;
            color: #7B1FA2;
        }

        .badge-docente {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .badge-visualizador {
            background: #FFF3E0;
            color: #EF6C00;
        }

        /* District Section */
        .distrito-section {
            margin-bottom: 2rem;
        }

        .distrito-header {
            background: linear-gradient(135deg, var(--secondary), #003D6E);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        /* Save Container */
        .save-container {
            position: sticky;
            bottom: 0;
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-top: 2rem;
        }

        /* Historial */
        .historial-item {
            background: #F7F9FC;
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary);
        }

        .historial-date {
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .historial-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .mt-2 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-gray { color: var(--gray); }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .attendance-row {
                grid-template-columns: 40px 1fr;
                gap: 0.75rem;
            }

            .checkbox-toggle {
                grid-column: 1 / -1;
            }

            .groups-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Modal Crear Usuario -->
    <div id="modalUsuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üë§ Crear Usuario</h3>
                <button class="modal-close" onclick="cerrarModal('modalUsuario')">&times;</button>
            </div>
            <form id="formCrearUsuario">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="nombreUsuario" required>
                </div>
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="usuarioLogin" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="passwordUsuario" required>
                </div>
                <button type="submit" class="btn btn-success">Crear Usuario</button>
            </form>
        </div>
    </div>

    <!-- Modal Asignar Rol -->
    <div id="modalRol" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üéØ Asignar Rol</h3>
                <button class="modal-close" onclick="cerrarModal('modalRol')">&times;</button>
            </div>
            <form id="formAsignarRol">
                <div class="form-group">
                    <label>Seleccionar Usuario</label>
                    <select id="selectUsuario" required>
                        <option value="">Selecciona un usuario</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <select id="selectRol" required onchange="toggleCamposRol()">
                        <option value="">Selecciona un rol</option>
                        <option value="docente">Docente</option>
                        <option value="visualizador">Visualizador (Solo consulta)</option>
                    </select>
                </div>
                <div id="camposDocente" class="hidden">
                    <div class="form-group">
                        <label>Grupos y Asignaturas</label>
                        <div id="asignacionesContainer"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="agregarAsignacion()">
                            + Agregar Grupo
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Asignar Rol</button>
            </form>
        </div>
    </div>

    <!-- Modal Detalle de Asistencia -->
    <div id="modalDetalleAsistencia" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">üë• Detalle de Asistencia</h3>
                <button class="modal-close" onclick="cerrarModal('modalDetalleAsistencia')">&times;</button>
            </div>
            <div id="detalleAsistenciaContent"></div>
        </div>
    </div>

    <!-- Modal Editar Usuario -->
    <div id="modalEditarUsuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚úèÔ∏è Editar Usuario</h3>
                <button class="modal-close" onclick="cerrarModal('modalEditarUsuario')">&times;</button>
            </div>
            <form id="formEditarUsuario">
                <input type="hidden" id="editUsuarioId">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="editNombreUsuario" required>
                </div>
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="editUsuarioLogin" required>
                </div>
                <div class="form-group">
                    <label>Nueva Contrase√±a (dejar vac√≠o para mantener la actual)</label>
                    <input type="password" id="editPasswordUsuario" placeholder="Solo si deseas cambiarla">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Guardar Cambios</button>
                    <button type="button" class="btn btn-danger" onclick="eliminarUsuario()" style="flex: 1;">Eliminar Usuario</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== CONFIGURACI√ìN FIREBASE ====================
          const firebaseConfig = {

  apiKey: "AIzaSyDve6JG6Yz5c3rVSzaXOPd6SLiXzOxKHEc",

  authDomain: "asistencia-crece.firebaseapp.com",

  projectId: "asistencia-crece",

  storageBucket: "asistencia-crece.firebasestorage.app",

  messagingSenderId: "598785147177",

  appId: "1:598785147177:web:d9a0a18c3718511a07f738"

};

        let db;
        let firebaseConfigured = false;

        try {
            if (firebaseConfig.apiKey !== "TU_API_KEY_AQUI") {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                firebaseConfigured = true;
            }
        } catch (error) {
            console.error("Error inicializando Firebase:", error);
        }

        // ==================== ESTADO DE LA APLICACI√ìN ====================
        let currentUser = null;
        let currentScreen = 'login';
        let currentTab = 'grupos';
        let grupoActual = null;
        let asignaturaActual = null;
        
        let distritos = ['01-01', '01-02', '01-03', '01-04', '01-05'];
        let asignaturas = ['Lengua Espa√±ola', 'Matem√°tica', 'Ciencias Sociales', 'Ciencias Naturales'];
        let grupos = [];
        let usuarios = [];
        let participantes = [];
        let asistencias = [];
        
        let asistenciaTemporal = {};
        let tipoEncuentro = 'presencial';
        let contadorAsignaciones = 0;
        let configuracion = {
            permitirEditarCentros: false
        };

        // ==================== FUNCIONES DE BASE DE DATOS ====================
        async function cargarDatos() {
            if (!firebaseConfigured) return;

            try {
                const gruposSnapshot = await db.collection('grupos').get();
                grupos = gruposSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const usuariosSnapshot = await db.collection('usuarios').get();
                usuarios = usuariosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const participantesSnapshot = await db.collection('participantes').get();
                participantes = participantesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const asistenciasSnapshot = await db.collection('asistencias').get();
                asistencias = asistenciasSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Cargar configuraci√≥n
                const configDoc = await db.collection('configuracion').doc('general').get();
                if (configDoc.exists) {
                    configuracion = { ...configuracion, ...configDoc.data() };
                }

                render();
            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarAlerta('Error cargando datos de Firebase', 'danger');
            }
        }

        async function crearGrupo(distrito, nombreGrupo) {
            try {
                const grupoData = {
                    distrito: distrito,
                    nombre: nombreGrupo,
                    fechaCreacion: new Date().toISOString()
                };
                
                const docRef = await db.collection('grupos').add(grupoData);
                grupos.push({ id: docRef.id, ...grupoData });
                
                mostrarAlerta('‚úÖ Grupo creado exitosamente', 'success');
                render();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al crear grupo', 'danger');
            }
        }

        async function eliminarGrupo(grupoId) {
            if (!confirm('¬øEst√°s seguro de eliminar este grupo?')) return;

            try {
                await db.collection('grupos').doc(grupoId).delete();
                grupos = grupos.filter(g => g.id !== grupoId);
                mostrarAlerta('Grupo eliminado correctamente', 'success');
                render();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al eliminar grupo', 'danger');
            }
        }

        async function crearUsuario(nombre, usuario, password) {
            // Verificar si el usuario ya existe
            const usuarioExiste = usuarios.find(u => u.usuario === usuario);
            if (usuarioExiste) {
                mostrarAlerta('‚ùå El usuario ya existe', 'danger');
                return;
            }

            try {
                const docRef = await db.collection('usuarios').add({
                    nombre: nombre,
                    usuario: usuario,
                    password: password,
                    rol: null,
                    asignaciones: [],
                    fechaCreacion: new Date().toISOString()
                });
                
                usuarios.push({
                    id: docRef.id,
                    nombre, usuario, password, rol: null, asignaciones: []
                });
                
                mostrarAlerta('‚úÖ Usuario creado exitosamente', 'success');
                document.getElementById('formCrearUsuario').reset();
                cerrarModal('modalUsuario');
                actualizarSelectUsuarios();
                render();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al crear usuario', 'danger');
            }
        }

        async function asignarRol(usuarioId, rol, asignaciones = []) {
            try {
                await db.collection('usuarios').doc(usuarioId).update({
                    rol: rol,
                    asignaciones: asignaciones
                });
                
                const index = usuarios.findIndex(u => u.id === usuarioId);
                if (index >= 0) {
                    usuarios[index].rol = rol;
                    usuarios[index].asignaciones = asignaciones;
                }
                
                mostrarAlerta('‚úÖ Rol asignado exitosamente', 'success');
                cerrarModal('modalRol');
                render();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al asignar rol', 'danger');
            }
        }

        async function cargarParticipantes(distrito, grupoId, datos) {
            try {
                const participantesAntiguos = participantes.filter(p => 
                    p.distrito === distrito && p.grupoId === grupoId
                );

                const batch = db.batch();
                participantesAntiguos.forEach(p => {
                    batch.delete(db.collection('participantes').doc(p.id));
                });
                await batch.commit();

                const promises = datos.map(item => 
                    db.collection('participantes').add({
                        nombre: item.nombre,
                        apellido: item.apellido,
                        centro: item.centro,
                        distrito: distrito,
                        grupoId: grupoId,
                        fechaCarga: new Date().toISOString()
                    })
                );

                const results = await Promise.all(promises);
                
                participantes = participantes.filter(p => 
                    !(p.distrito === distrito && p.grupoId === grupoId)
                );
                
                results.forEach((docRef, index) => {
                    participantes.push({
                        id: docRef.id,
                        ...datos[index],
                        distrito,
                        grupoId
                    });
                });

                mostrarAlerta(`‚úÖ ${datos.length} participantes cargados`, 'success');
                render();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar participantes', 'danger');
            }
        }

        async function guardarAsistenciaCompleta(fecha, tipo, grupoId, asignatura, participantesData) {
            try {
                const asistenciaId = `${fecha}_${grupoId}_${asignatura.replace(/\s/g, '')}`;
                
                // Verificar si ya existe asistencia para este d√≠a
                const asistenciaExistente = asistencias.find(a => a.id === asistenciaId);
                
                if (asistenciaExistente) {
                    const confirmar = confirm('‚ö†Ô∏è Ya existe una asistencia para este grupo y asignatura en esta fecha.\n\n¬øDeseas reemplazarla?');
                    if (!confirmar) return;
                }
                
                const asistenciaData = {
                    fecha: fecha,
                    tipoEncuentro: tipo,
                    usuarioId: currentUser.id,
                    nombreDocente: currentUser.nombre,
                    grupoId: grupoId,
                    asignatura: asignatura,
                    participantes: participantesData,
                    fechaGuardado: new Date().toISOString()
                };

                await db.collection('asistencias').doc(asistenciaId).set(asistenciaData);

                const index = asistencias.findIndex(a => a.id === asistenciaId);
                if (index >= 0) {
                    asistencias[index] = { id: asistenciaId, ...asistenciaData };
                } else {
                    asistencias.push({ id: asistenciaId, ...asistenciaData });
                }

                mostrarAlerta('‚úÖ Asistencia guardada exitosamente', 'success');
                asistenciaTemporal = {};
                grupoActual = null;
                asignaturaActual = null;
                render();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al guardar asistencia', 'danger');
            }
        }

        // ==================== FUNCIONES DE UI ====================
        function mostrarAlerta(mensaje, tipo = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.textContent = mensaje;
            
            const container = document.querySelector('.container') || document.body;
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => alertDiv.remove(), 300);
            }, 4000);
        }

        function abrirModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function toggleCamposRol() {
            const rol = document.getElementById('selectRol').value;
            const camposDocente = document.getElementById('camposDocente');
            
            if (rol === 'docente') {
                camposDocente.classList.remove('hidden');
            } else {
                camposDocente.classList.add('hidden');
            }
        }

        function agregarAsignacion() {
            contadorAsignaciones++;
            const container = document.getElementById('asignacionesContainer');
            const div = document.createElement('div');
            div.className = 'form-group';
            div.id = `asignacion-${contadorAsignaciones}`;
            div.innerHTML = `
                <div style="border: 2px solid #E8E8F0; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong>Asignaci√≥n #${contadorAsignaciones}</strong>
                        <button type="button" onclick="eliminarAsignacion(${contadorAsignaciones})" style="background: var(--danger); color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer;">‚úï</button>
                    </div>
                    <select class="asignacion-distrito" required style="margin-bottom: 0.5rem;" onchange="actualizarGruposAsignacion(${contadorAsignaciones})">
                        <option value="">Selecciona distrito</option>
                        ${distritos.map(d => `<option value="${d}">${d}</option>`).join('')}
                    </select>
                    <select class="asignacion-grupo" id="grupo-${contadorAsignaciones}" required style="margin-bottom: 0.5rem;">
                        <option value="">Primero selecciona distrito</option>
                    </select>
                    <select class="asignacion-asignatura" required>
                        <option value="">Selecciona asignatura</option>
                        ${asignaturas.map(a => `<option value="${a}">${a}</option>`).join('')}
                    </select>
                </div>
            `;
            container.appendChild(div);
        }

        function eliminarAsignacion(id) {
            const element = document.getElementById(`asignacion-${id}`);
            if (element) element.remove();
        }

        function actualizarGruposAsignacion(id) {
            const asignacionDiv = document.getElementById(`asignacion-${id}`);
            const distritoSelect = asignacionDiv.querySelector('.asignacion-distrito');
            const grupoSelect = document.getElementById(`grupo-${id}`);
            
            const distrito = distritoSelect.value;
            const gruposDistrito = grupos.filter(g => g.distrito === distrito);

            if (gruposDistrito.length === 0) {
                grupoSelect.innerHTML = '<option value="">No hay grupos en este distrito</option>';
            } else {
                grupoSelect.innerHTML = '<option value="">Selecciona un grupo</option>' +
                    gruposDistrito.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
            }
        }

        function actualizarSelectUsuarios() {
            const select = document.getElementById('selectUsuario');
            select.innerHTML = '<option value="">Selecciona un usuario</option>' +
                usuarios.map(u => `<option value="${u.id}">${u.nombre} (${u.usuario})</option>`).join('');
        }

        function verDetalleAsistencia(asistenciaId) {
            const asistencia = asistencias.find(a => a.id === asistenciaId);
            if (!asistencia) return;

            const presentes = asistencia.participantes.filter(p => p.presente);
            const ausentes = asistencia.participantes.filter(p => p.ausente);
            const sinMarcar = asistencia.participantes.filter(p => !p.presente && !p.ausente);

            let html = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: #E8F5E9; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #2E7D32;">${presentes.length}</div>
                            <div style="font-size: 0.85rem; color: #2E7D32;">Presentes</div>
                        </div>
                        <div style="background: #FFEBEE; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #C62828;">${ausentes.length}</div>
                            <div style="font-size: 0.85rem; color: #C62828;">Ausentes</div>
                        </div>
                        ${sinMarcar.length > 0 ? `
                        <div style="background: #FFF3E0; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #E65100;">${sinMarcar.length}</div>
                            <div style="font-size: 0.85rem; color: #E65100;">Sin marcar</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: #F7F9FC; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <strong>Fecha:</strong> ${asistencia.fecha}<br>
                        <strong>Asignatura:</strong> ${asistencia.asignatura}<br>
                        <strong>Tipo:</strong> <span class="badge badge-${asistencia.tipoEncuentro}">${asistencia.tipoEncuentro}</span>
                    </div>
                </div>

                ${presentes.length > 0 ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #2E7D32; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">‚úì</span> Presentes (${presentes.length})
                        </h4>
                        <div style="display: grid; gap: 0.5rem;">
                            ${presentes.map((p, index) => `
                                <div style="background: #E8F5E9; padding: 0.75rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="background: #2E7D32; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">
                                        ${index + 1}
                                    </span>
                                    <div>
                                        <div style="font-weight: 600; color: #1B5E20;">${p.nombre} ${p.apellido}</div>
                                        <div style="font-size: 0.85rem; color: #2E7D32;">${p.centro}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                ${ausentes.length > 0 ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #C62828; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">‚úó</span> Ausentes (${ausentes.length})
                        </h4>
                        <div style="display: grid; gap: 0.5rem;">
                            ${ausentes.map((p, index) => `
                                <div style="background: #FFEBEE; padding: 0.75rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="background: #C62828; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">
                                        ${index + 1}
                                    </span>
                                    <div>
                                        <div style="font-weight: 600; color: #B71C1C;">${p.nombre} ${p.apellido}</div>
                                        <div style="font-size: 0.85rem; color: #C62828;">${p.centro}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                ${sinMarcar.length > 0 ? `
                    <div>
                        <h4 style="color: #E65100; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">‚óã</span> Sin marcar (${sinMarcar.length})
                        </h4>
                        <div style="display: grid; gap: 0.5rem;">
                            ${sinMarcar.map((p, index) => `
                                <div style="background: #FFF3E0; padding: 0.75rem; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                                    <span style="background: #E65100; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">
                                        ${index + 1}
                                    </span>
                                    <div>
                                        <div style="font-weight: 600; color: #E65100;">${p.nombre} ${p.apellido}</div>
                                        <div style="font-size: 0.85rem; color: #F57C00;">${p.centro}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            document.getElementById('detalleAsistenciaContent').innerHTML = html;
            abrirModal('modalDetalleAsistencia');
        }

        function abrirEditarUsuario(usuarioId) {
            const usuario = usuarios.find(u => u.id === usuarioId);
            if (!usuario) return;

            document.getElementById('editUsuarioId').value = usuario.id;
            document.getElementById('editNombreUsuario').value = usuario.nombre;
            document.getElementById('editUsuarioLogin').value = usuario.usuario;
            document.getElementById('editPasswordUsuario').value = '';
            
            abrirModal('modalEditarUsuario');
        }

        async function editarUsuario(usuarioId, nombre, usuario, password) {
            try {
                const updateData = {
                    nombre: nombre,
                    usuario: usuario
                };

                // Solo actualizar password si se proporcion√≥ uno nuevo
                if (password && password.trim() !== '') {
                    updateData.password = password;
                }

                await db.collection('usuarios').doc(usuarioId).update(updateData);
                
                const index = usuarios.findIndex(u => u.id === usuarioId);
                if (index >= 0) {
                    usuarios[index].nombre = nombre;
                    usuarios[index].usuario = usuario;
                    if (password && password.trim() !== '') {
                        usuarios[index].password = password;
                    }
                }
                
                mostrarAlerta('‚úÖ Usuario actualizado exitosamente', 'success');
                cerrarModal('modalEditarUsuario');
                render();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al actualizar usuario', 'danger');
            }
        }

        async function eliminarUsuario() {
            const usuarioId = document.getElementById('editUsuarioId').value;
            
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar este usuario?\n\nEsta acci√≥n no se puede deshacer.')) {
                return;
            }

            try {
                await db.collection('usuarios').doc(usuarioId).delete();
                usuarios = usuarios.filter(u => u.id !== usuarioId);
                
                mostrarAlerta('‚úÖ Usuario eliminado correctamente', 'success');
                cerrarModal('modalEditarUsuario');
                render();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al eliminar usuario', 'danger');
            }
        }

        function descargarAsistenciaExcel(asistenciaId) {
            const asistencia = asistencias.find(a => a.id === asistenciaId);
            if (!asistencia) return;

            const grupo = grupos.find(g => g.id === asistencia.grupoId);
            
            // Preparar datos para Excel
            const datos = asistencia.participantes.map((p, index) => ({
                'No.': index + 1,
                'Nombre': p.nombre,
                'Apellido': p.apellido,
                'Centro Educativo': p.centro,
                'Asistencia': p.presente ? 'Presente' : (p.ausente ? 'Ausente' : 'Sin marcar')
            }));

            // Crear worksheet
            const ws = XLSX.utils.json_to_sheet(datos);

            // Ajustar ancho de columnas
            ws['!cols'] = [
                { wch: 6 },  // No.
                { wch: 20 }, // Nombre
                { wch: 20 }, // Apellido
                { wch: 40 }, // Centro
                { wch: 12 }  // Asistencia
            ];

            // Crear workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Asistencia');

            // Agregar hoja de resumen
            const resumen = [
                { 'Campo': 'Fecha', 'Valor': asistencia.fecha },
                { 'Campo': 'Distrito', 'Valor': obtenerDistritoGrupo(asistencia.grupoId) },
                { 'Campo': 'Grupo', 'Valor': grupo ? grupo.nombre : 'N/A' },
                { 'Campo': 'Asignatura', 'Valor': asistencia.asignatura },
                { 'Campo': 'Docente', 'Valor': asistencia.nombreDocente || 'N/A' },
                { 'Campo': 'Tipo de Encuentro', 'Valor': asistencia.tipoEncuentro },
                { 'Campo': '', 'Valor': '' },
                { 'Campo': 'Total Participantes', 'Valor': asistencia.participantes.length },
                { 'Campo': 'Presentes', 'Valor': asistencia.participantes.filter(p => p.presente).length },
                { 'Campo': 'Ausentes', 'Valor': asistencia.participantes.filter(p => p.ausente).length },
                { 'Campo': 'Sin Marcar', 'Valor': asistencia.participantes.filter(p => !p.presente && !p.ausente).length }
            ];
            
            const wsResumen = XLSX.utils.json_to_sheet(resumen);
            wsResumen['!cols'] = [{ wch: 20 }, { wch: 30 }];
            XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');

            // Descargar
            const fileName = `Asistencia_${grupo ? grupo.nombre : 'Grupo'}_${asistencia.asignatura}_${asistencia.fecha}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            mostrarAlerta('‚úÖ Excel descargado exitosamente', 'success');
        }

        function descargarTodasAsistenciasFecha(fecha) {
            const asistenciasFecha = asistencias.filter(a => a.fecha === fecha);
            
            if (asistenciasFecha.length === 0) {
                mostrarAlerta('No hay asistencias para esta fecha', 'warning');
                return;
            }

            const wb = XLSX.utils.book_new();

            asistenciasFecha.forEach(asistencia => {
                const grupo = grupos.find(g => g.id === asistencia.grupoId);
                
                const datos = asistencia.participantes.map((p, index) => ({
                    'No.': index + 1,
                    'Nombre': p.nombre,
                    'Apellido': p.apellido,
                    'Centro Educativo': p.centro,
                    'Asistencia': p.presente ? 'Presente' : (p.ausente ? 'Ausente' : 'Sin marcar')
                }));

                const ws = XLSX.utils.json_to_sheet(datos);
                ws['!cols'] = [
                    { wch: 6 }, { wch: 20 }, { wch: 20 }, { wch: 40 }, { wch: 12 }
                ];

                const sheetName = `${grupo ? grupo.nombre : 'Grupo'} - ${asistencia.asignatura}`.substring(0, 31);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });

            // Hoja de resumen general
            const resumenGeneral = asistenciasFecha.map(a => {
                const grupo = grupos.find(g => g.id === a.grupoId);
                return {
                    'Distrito': obtenerDistritoGrupo(a.grupoId),
                    'Grupo': grupo ? grupo.nombre : 'N/A',
                    'Asignatura': a.asignatura,
                    'Docente': a.nombreDocente || 'N/A',
                    'Tipo': a.tipoEncuentro,
                    'Total': a.participantes.length,
                    'Presentes': a.participantes.filter(p => p.presente).length,
                    'Ausentes': a.participantes.filter(p => p.ausente).length
                };
            });

            const wsResumen = XLSX.utils.json_to_sheet(resumenGeneral);
            wsResumen['!cols'] = [
                { wch: 10 }, { wch: 20 }, { wch: 25 }, { wch: 20 }, 
                { wch: 12 }, { wch: 8 }, { wch: 10 }, { wch: 10 }
            ];
            XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen General');

            const fileName = `Asistencias_${fecha}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            mostrarAlerta('‚úÖ Excel descargado exitosamente', 'success');
        }

        async function toggleEditarCentros() {
            try {
                const nuevoEstado = !configuracion.permitirEditarCentros;
                
                await db.collection('configuracion').doc('general').set({
                    permitirEditarCentros: nuevoEstado
                });
                
                configuracion.permitirEditarCentros = nuevoEstado;
                
                mostrarAlerta(
                    nuevoEstado ? 
                    '‚úÖ Edici√≥n de centros HABILITADA' : 
                    '‚õî Edici√≥n de centros DESHABILITADA', 
                    nuevoEstado ? 'success' : 'warning'
                );
                
                render();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al cambiar configuraci√≥n', 'danger');
            }
        }

        async function actualizarCentroEducativo(participanteId, nuevoCentro) {
            try {
                await db.collection('participantes').doc(participanteId).update({
                    centro: nuevoCentro
                });
                
                const index = participantes.findIndex(p => p.id === participanteId);
                if (index >= 0) {
                    participantes[index].centro = nuevoCentro;
                }
                
                mostrarAlerta('‚úÖ Centro educativo actualizado', 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al actualizar centro', 'danger');
            }
        }

        function login(usuario, password) {
            // Admin login
            if (usuario === 'admin' && password === 'E.r40%6205$C') {
                currentUser = { tipo: 'admin', usuario: 'admin' };
                currentScreen = 'dashboard';
                render();
                return true;
            }
            
            // User login
            const user = usuarios.find(u => u.usuario === usuario && u.password === password);
            
            if (user) {
                if (!user.rol) {
                    mostrarAlerta('Este usuario no tiene un rol asignado. Contacta al administrador.', 'warning');
                    return false;
                }
                
                currentUser = { tipo: user.rol, ...user };
                currentScreen = 'dashboard';
                render();
                return true;
            }
            
            mostrarAlerta('Usuario o contrase√±a incorrectos', 'danger');
            return false;
        }

        function logout() {
            currentUser = null;
            currentScreen = 'login';
            currentTab = 'grupos';
            grupoActual = null;
            asignaturaActual = null;
            asistenciaTemporal = {};
            render();
        }

        function cambiarTab(tab) {
            currentTab = tab;
            render();
        }

        function iniciarPaseLista(grupoId, asignatura) {
            grupoActual = grupoId;
            asignaturaActual = asignatura;
            asistenciaTemporal = {};
            tipoEncuentro = 'presencial';
            render();
        }

        function cancelarPaseLista() {
            grupoActual = null;
            asignaturaActual = null;
            asistenciaTemporal = {};
            render();
        }

        function obtenerNombreGrupo(grupoId) {
            const grupo = grupos.find(g => g.id === grupoId);
            return grupo ? grupo.nombre : 'N/A';
        }

        function obtenerDistritoGrupo(grupoId) {
            const grupo = grupos.find(g => g.id === grupoId);
            return grupo ? grupo.distrito : 'N/A';
        }

        function obtenerParticipantesGrupo(grupoId) {
            return participantes.filter(p => p.grupoId === grupoId);
        }

        function obtenerAsistenciasGrupo(grupoId, asignatura) {
            return asistencias.filter(a => 
                a.grupoId === grupoId && a.asignatura === asignatura
            ).sort((a, b) => b.fecha.localeCompare(a.fecha));
        }

        function toggleAsistenciaTemporal(participanteId, tipo) {
            if (!asistenciaTemporal[participanteId]) {
                asistenciaTemporal[participanteId] = { presente: false, ausente: false };
            }

            if (tipo === 'presente') {
                asistenciaTemporal[participanteId].presente = !asistenciaTemporal[participanteId].presente;
                if (asistenciaTemporal[participanteId].presente) {
                    asistenciaTemporal[participanteId].ausente = false;
                }
            } else {
                asistenciaTemporal[participanteId].ausente = !asistenciaTemporal[participanteId].ausente;
                if (asistenciaTemporal[participanteId].ausente) {
                    asistenciaTemporal[participanteId].presente = false;
                }
            }

            actualizarContadores();
        }

        function cambiarTipoEncuentro(tipo) {
            tipoEncuentro = tipo;
        }

        function actualizarContadores() {
            setTimeout(() => {
                const presentes = Object.values(asistenciaTemporal).filter(a => a.presente).length;
                const ausentes = Object.values(asistenciaTemporal).filter(a => a.ausente).length;
                
                const contadorPresentes = document.getElementById('contadorPresentes');
                const contadorAusentes = document.getElementById('contadorAusentes');
                
                if (contadorPresentes) contadorPresentes.textContent = presentes;
                if (contadorAusentes) contadorAusentes.textContent = ausentes;
            }, 100);
        }

        function guardarAsistencia() {
            const fecha = document.getElementById('fechaAsistencia').value;
            const misParticipantes = obtenerParticipantesGrupo(grupoActual);
            
            // Validar que todos los participantes est√©n marcados
            const sinMarcar = misParticipantes.filter(p => {
                const asist = asistenciaTemporal[p.id] || { presente: false, ausente: false };
                return !asist.presente && !asist.ausente;
            });

            if (sinMarcar.length > 0) {
                mostrarAlerta(
                    `‚ö†Ô∏è Faltan ${sinMarcar.length} participante(s) por marcar.\n\nTodos deben estar marcados como Presente o Ausente.`, 
                    'warning'
                );
                return;
            }
            
            const participantesData = misParticipantes.map(p => ({
                id: p.id,
                nombre: p.nombre,
                apellido: p.apellido,
                centro: p.centro,
                presente: asistenciaTemporal[p.id]?.presente || false,
                ausente: asistenciaTemporal[p.id]?.ausente || false
            }));
            
            guardarAsistenciaCompleta(fecha, tipoEncuentro, grupoActual, asignaturaActual, participantesData);
        }

        function renderCheckboxes() {
            const misParticipantes = obtenerParticipantesGrupo(grupoActual);
            
            misParticipantes.forEach(p => {
                const asist = asistenciaTemporal[p.id] || { presente: false, ausente: false };
                const presenteCheck = document.querySelector(`.presente-check[data-id="${p.id}"]`);
                const ausenteCheck = document.querySelector(`.ausente-check[data-id="${p.id}"]`);
                
                if (presenteCheck) presenteCheck.checked = asist.presente;
                if (ausenteCheck) ausenteCheck.checked = asist.ausente;
            });
            
            actualizarContadores();
        }

        // ==================== PROCESAMIENTO DE EXCEL ====================
        function procesarExcel(file, distrito, grupoId) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    // Filtrar filas vac√≠as o sin datos v√°lidos
                    const participantesData = jsonData
                        .map(row => ({
                            nombre: row.Nombre || row.nombre || '',
                            apellido: row.Apellido || row.apellido || '',
                            centro: row['Centro educativo donde trabaja'] || row.centro || row.Centro || ''
                        }))
                        .filter(p => {
                            // Solo incluir si tiene al menos nombre y apellido
                            return p.nombre.trim() !== '' && p.apellido.trim() !== '';
                        });

                    if (participantesData.length === 0) {
                        mostrarAlerta('El archivo Excel est√° vac√≠o o no tiene datos v√°lidos', 'warning');
                        return;
                    }

                    cargarParticipantes(distrito, grupoId, participantesData);
                } catch (error) {
                    console.error('Error:', error);
                    mostrarAlerta('Error al procesar el archivo Excel', 'danger');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // ==================== RENDERIZADO ====================
        function render() {
            const app = document.getElementById('app');
            
            if (!firebaseConfigured) {
                app.innerHTML = '<div class="login-container"><div class="login-card"><h1>Firebase no configurado</h1></div></div>';
                return;
            }

            if (currentScreen === 'login') {
                app.innerHTML = renderLogin();
                attachLoginHandlers();
            } else if (currentScreen === 'dashboard') {
                if (currentUser.tipo === 'admin') {
                    app.innerHTML = renderAdminDashboard();
                    attachAdminHandlers();
                } else if (currentUser.tipo === 'docente') {
                    if (grupoActual && asignaturaActual) {
                        app.innerHTML = renderPaseLista();
                        attachPaseListaHandlers();
                    } else {
                        app.innerHTML = renderDocenteDashboard();
                    }
                } else if (currentUser.tipo === 'visualizador') {
                    app.innerHTML = renderVisualizadorDashboard();
                }
            }
        }

        function renderLogin() {
            return `
                <div class="login-container">
                    <div class="login-card">
                        <div class="login-header">
                            <h1>üéì Sistema CRECE</h1>
                            <p>Control de Asistencia v3</p>
                        </div>
                        
                        <form id="loginForm">
                            <div class="form-group">
                                <label>Usuario</label>
                                <input type="text" id="usuario" placeholder="Ingresa tu usuario" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Contrase√±a</label>
                                <input type="password" id="password" placeholder="Ingresa tu contrase√±a" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                Iniciar Sesi√≥n
                            </button>
                        </form>
                        
                        <div class="alert alert-info mt-2">
                            <strong>Credenciales de prueba:</strong><br>
                            Admin: <code>admin</code> / <code>E.r40%6205$C</code>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminDashboard() {
            return `
                <div class="container dashboard">
                    <div class="dashboard-header">
                        <h2>Panel de Administraci√≥n</h2>
                        <div class="user-info">
                            <span class="user-badge">üë®‚Äçüíº Administrador</span>
                            <button class="btn btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="tabs">
                            <button class="tab ${currentTab === 'grupos' ? 'active' : ''}" onclick="cambiarTab('grupos')">
                                üìÅ Grupos
                            </button>
                            <button class="tab ${currentTab === 'excel' ? 'active' : ''}" onclick="cambiarTab('excel')">
                                üìä Participantes
                            </button>
                            <button class="tab ${currentTab === 'usuarios' ? 'active' : ''}" onclick="cambiarTab('usuarios')">
                                üë• Usuarios
                            </button>
                            <button class="tab ${currentTab === 'asistencias' ? 'active' : ''}" onclick="cambiarTab('asistencias')">
                                üìà Asistencias
                            </button>
                            <button class="tab ${currentTab === 'configuracion' ? 'active' : ''}" onclick="cambiarTab('configuracion')">
                                ‚öôÔ∏è Configuraci√≥n
                            </button>
                        </div>
                        
                        <div id="tabContent">
                            ${renderTabContent()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTabContent() {
            switch (currentTab) {
                case 'grupos': return renderGruposTab();
                case 'excel': return renderExcelTab();
                case 'usuarios': return renderUsuariosTab();
                case 'asistencias': return renderAsistenciasAdminTab();
                case 'configuracion': return renderConfiguracionTab();
                default: return '';
            }
        }

        function renderGruposTab() {
            let html = `
                <div class="card-header">
                    <h3 class="card-title">Gesti√≥n de Grupos</h3>
                </div>
                
                <div class="alert alert-info">
                    Total de grupos: <strong>${grupos.length}</strong>
                </div>
                
                <form id="crearGrupoForm" class="mb-2">
                    <div class="form-group">
                        <label>Distrito</label>
                        <select id="distritoGrupo" required>
                            <option value="">Selecciona un distrito</option>
                            ${distritos.map(d => `<option value="${d}">${d}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Nombre del Grupo</label>
                        <input type="text" id="nombreGrupo" placeholder="Ej: Grupo A, Primer Ciclo..." required>
                    </div>
                    
                    <button type="submit" class="btn btn-success">‚ûï Crear Grupo</button>
                </form>
                
                <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--secondary);">Grupos Creados</h4>
            `;

            distritos.forEach(distrito => {
                const gruposDistrito = grupos.filter(g => g.distrito === distrito);
                
                if (gruposDistrito.length > 0) {
                    html += `
                        <h5 style="margin-top: 1.5rem; color: var(--gray);">Distrito ${distrito} (${gruposDistrito.length})</h5>
                        <div class="groups-container">
                            ${gruposDistrito.map(grupo => `
                                <div class="group-card">
                                    <div class="group-header">
                                        <div class="group-title">${grupo.nombre}</div>
                                        <button onclick="eliminarGrupo('${grupo.id}')" style="background: var(--danger); color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer;">‚úï</button>
                                    </div>
                                    <div class="group-distrito">Distrito ${grupo.distrito}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });

            if (grupos.length === 0) {
                html += '<div class="alert alert-info">No hay grupos creados.</div>';
            }

            return html;
        }

        function renderExcelTab() {
            return `
                <div class="card-header">
                    <h3 class="card-title">Cargar Participantes</h3>
                </div>
                
                <div class="alert alert-info">
                    Los participantes son compartidos por las 4 asignaturas del grupo
                </div>
                
                <form id="cargarExcelForm">
                    <div class="form-group">
                        <label>Distrito</label>
                        <select id="distritoExcel" required onchange="actualizarGruposExcel()">
                            <option value="">Selecciona un distrito</option>
                            ${distritos.map(d => `<option value="${d}">${d}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Grupo</label>
                        <select id="grupoExcel" required>
                            <option value="">Primero selecciona un distrito</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Archivo Excel</label>
                        <div class="file-upload" id="fileUpload">
                            <input type="file" id="excelFile" accept=".xlsx,.xls" required>
                            <div class="upload-icon">üìÑ</div>
                            <p>Click para seleccionar archivo</p>
                            <small class="text-gray">Columnas: Nombre, Apellido, Centro educativo donde trabaja</small>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">üì§ Cargar Participantes</button>
                </form>
            `;
        }

        function renderUsuariosTab() {
            return `
                <div class="card-header">
                    <h3 class="card-title">Gesti√≥n de Usuarios</h3>
                    <div>
                        <button class="btn btn-success btn-sm" onclick="abrirModal('modalUsuario')">
                            üë§ Crear Usuario
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="abrirModal('modalRol')">
                            üéØ Asignar Rol
                        </button>
                    </div>
                </div>
                
                ${usuarios.length === 0 ? 
                    '<div class="alert alert-info">No hay usuarios registrados.</div>' :
                    `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Usuario</th>
                                    <th>Rol</th>
                                    <th>Asignaciones</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${usuarios.map(u => `
                                    <tr>
                                        <td><strong>${u.nombre}</strong></td>
                                        <td>${u.usuario}</td>
                                        <td>
                                            ${u.rol ? `<span class="badge badge-${u.rol}">${u.rol}</span>` : '<span class="text-gray">Sin rol</span>'}
                                        </td>
                                        <td>
                                            ${u.asignaciones && u.asignaciones.length > 0 ? 
                                                `${u.asignaciones.length} asignaci√≥n(es)` : 
                                                '<span class="text-gray">‚Äî</span>'
                                            }
                                        </td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" onclick="abrirEditarUsuario('${u.id}')" style="padding: 0.25rem 0.75rem;">
                                                ‚úèÔ∏è Editar
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    `
                }
            `;
        }

        function renderConfiguracionTab() {
            return `
                <div class="card-header">
                    <h3 class="card-title">Configuraci√≥n del Sistema</h3>
                </div>
                
                <div style="max-width: 600px;">
                    <div style="background: #F7F9FC; padding: 2rem; border-radius: 12px; border-left: 4px solid var(--primary);">
                        <h4 style="color: var(--secondary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ‚úèÔ∏è Edici√≥n de Centros Educativos
                        </h4>
                        
                        <p style="color: var(--gray); margin-bottom: 1.5rem; line-height: 1.6;">
                            Permite a los docentes editar el nombre del centro educativo de los participantes durante el pase de lista.
                        </p>
                        
                        <div style="display: flex; align-items: center; gap: 1rem; background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <strong style="color: var(--dark);">Estado actual:</strong>
                                <span style="display: block; margin-top: 0.25rem; color: ${configuracion.permitirEditarCentros ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">
                                    ${configuracion.permitirEditarCentros ? '‚úÖ HABILITADO' : '‚õî DESHABILITADO'}
                                </span>
                            </div>
                            <button 
                                class="btn ${configuracion.permitirEditarCentros ? 'btn-danger' : 'btn-success'}" 
                                onclick="toggleEditarCentros()"
                                style="white-space: nowrap;">
                                ${configuracion.permitirEditarCentros ? '‚õî Deshabilitar' : '‚úÖ Habilitar'}
                            </button>
                        </div>
                        
                        <div style="background: #FFF3E0; padding: 1rem; border-radius: 8px; font-size: 0.9rem; color: #E65100;">
                            <strong>‚ö†Ô∏è Importante:</strong> Los cambios afectan a todos los docentes inmediatamente.
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAsistenciasAdminTab() {
            const fechaFiltro = document.getElementById('filtroFechaAsistencia')?.value || '';
            
            let html = `
                <div class="card-header">
                    <h3 class="card-title">Todas las Asistencias</h3>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: end;">
                    <div class="form-group" style="max-width: 300px; margin-bottom: 0;">
                        <label>üîç Filtrar por Fecha</label>
                        <input type="date" id="filtroFechaAsistencia" value="${fechaFiltro}" onchange="render()" style="padding: 0.875rem 1rem;">
                    </div>
                    ${fechaFiltro ? `
                        <button class="btn btn-success btn-sm" onclick="descargarTodasAsistenciasFecha('${fechaFiltro}')" style="padding: 0.875rem 1.5rem;">
                            üì• Descargar Todo (${fechaFiltro})
                        </button>
                    ` : ''}
                </div>
            `;

            // Filtrar asistencias por fecha si hay filtro
            let asistenciasFiltradas = asistencias;
            if (fechaFiltro) {
                asistenciasFiltradas = asistencias.filter(a => a.fecha === fechaFiltro);
            }

            if (asistenciasFiltradas.length === 0) {
                html += `<div class="alert alert-info">No hay asistencias${fechaFiltro ? ' para la fecha seleccionada' : ' registradas'}.</div>`;
            } else {
                distritos.forEach(distrito => {
                    const gruposDistrito = grupos.filter(g => g.distrito === distrito);
                    
                    if (gruposDistrito.length > 0) {
                        const hayAsistencias = gruposDistrito.some(grupo => 
                            asistenciasFiltradas.some(a => a.grupoId === grupo.id)
                        );

                        if (hayAsistencias) {
                            html += `<div class="distrito-section">
                                <div class="distrito-header">
                                    <h4>Distrito ${distrito}</h4>
                                </div>`;
                            
                            gruposDistrito.forEach(grupo => {
                                const asistenciasGrupo = asistenciasFiltradas.filter(a => a.grupoId === grupo.id);
                                
                                if (asistenciasGrupo.length > 0) {
                                    html += `
                                        <h5 style="margin: 1rem 0 0.5rem; color: var(--secondary);">${grupo.nombre}</h5>
                                        <div class="table-container">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Fecha</th>
                                                        <th>Asignatura</th>
                                                        <th>Docente</th>
                                                        <th>Tipo</th>
                                                        <th>Presentes</th>
                                                        <th>Ausentes</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${asistenciasGrupo.map(a => {
                                                        const presentes = a.participantes.filter(p => p.presente).length;
                                                        const ausentes = a.participantes.filter(p => p.ausente).length;
                                                        return `
                                                            <tr>
                                                                <td>${a.fecha}</td>
                                                                <td>${a.asignatura}</td>
                                                                <td>${a.nombreDocente || 'N/A'}</td>
                                                                <td><span class="badge badge-${a.tipoEncuentro}">${a.tipoEncuentro}</span></td>
                                                                <td class="text-success"><strong>${presentes}</strong></td>
                                                                <td class="text-danger"><strong>${ausentes}</strong></td>
                                                                <td>
                                                                    <button class="btn btn-secondary btn-sm" onclick="verDetalleAsistencia('${a.id}')" style="padding: 0.25rem 0.75rem; margin-right: 0.25rem;">
                                                                        üëÅÔ∏è Ver
                                                                    </button>
                                                                    <button class="btn btn-success btn-sm" onclick="descargarAsistenciaExcel('${a.id}')" style="padding: 0.25rem 0.75rem;">
                                                                        üì• Excel
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    `;
                                }
                            });
                            
                            html += '</div>';
                        }
                    }
                });
            }

            return html;
        }

        function renderDocenteDashboard() {
            let html = `
                <div class="container dashboard">
                    <div class="dashboard-header">
                        <div>
                            <h2>Panel de Docente</h2>
                            <p class="text-gray">${currentUser.nombre}</p>
                        </div>
                        <div class="user-info">
                            <span class="user-badge">üë©‚Äçüè´ Docente</span>
                            <button class="btn btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
                        </div>
                    </div>
            `;

            if (!currentUser.asignaciones || currentUser.asignaciones.length === 0) {
                html += '<div class="card"><div class="alert alert-warning">No tienes grupos asignados todav√≠a.</div></div>';
            } else {
                // Agrupar por distrito
                const porDistrito = {};
                currentUser.asignaciones.forEach(asig => {
                    const distrito = obtenerDistritoGrupo(asig.grupoId);
                    if (!porDistrito[distrito]) porDistrito[distrito] = [];
                    porDistrito[distrito].push(asig);
                });

                Object.keys(porDistrito).sort().forEach(distrito => {
                    html += `
                        <div class="card">
                            <div class="distrito-header">
                                <h3>Distrito ${distrito}</h3>
                            </div>
                            <div class="groups-container">
                    `;

                    porDistrito[distrito].forEach(asig => {
                        const grupo = grupos.find(g => g.id === asig.grupoId);
                        const participantesGrupo = obtenerParticipantesGrupo(asig.grupoId);
                        const historial = obtenerAsistenciasGrupo(asig.grupoId, asig.asignatura);

                        html += `
                            <div class="group-card">
                                <div class="group-header">
                                    <div class="group-title">${grupo ? grupo.nombre : 'N/A'}</div>
                                </div>
                                <div class="asignatura-tag">${asig.asignatura}</div>
                                <p class="text-gray" style="margin: 0.5rem 0; font-size: 0.85rem;">
                                    ${participantesGrupo.length} participantes
                                </p>
                                
                                <button class="btn btn-primary btn-sm" onclick="iniciarPaseLista('${asig.grupoId}', '${asig.asignatura}')" style="width: 100%; margin-top: 0.5rem;">
                                    ‚úèÔ∏è Pasar Lista
                                </button>
                                
                                ${historial.length > 0 ? `
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #E8E8F0;">
                                        <h5 style="font-size: 0.85rem; color: var(--gray); margin-bottom: 0.5rem;">√öltimas asistencias:</h5>
                                        ${historial.slice(0, 3).map(h => {
                                            const presentes = h.participantes.filter(p => p.presente).length;
                                            const ausentes = h.participantes.filter(p => p.ausente).length;
                                            return `
                                                <div class="historial-item" style="padding: 0.5rem; margin-bottom: 0.25rem;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span style="font-size: 0.75rem;">${h.fecha}</span>
                                                        <span class="badge badge-${h.tipoEncuentro}">${h.tipoEncuentro}</span>
                                                    </div>
                                                    <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">
                                                        ‚úì ${presentes} | ‚úó ${ausentes}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });
            }

            html += '</div>';
            return html;
        }

        function renderPaseLista() {
            const grupo = grupos.find(g => g.id === grupoActual);
            const misParticipantes = obtenerParticipantesGrupo(grupoActual);
            const fechaHoy = new Date().toISOString().split('T')[0];
            const fechaFormateada = new Date().toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            return `
                <div class="container dashboard">
                    <div class="dashboard-header">
                        <div>
                            <h2>Pase de Lista</h2>
                            <p class="text-gray">${grupo ? grupo.nombre : 'N/A'} - ${asignaturaActual}</p>
                        </div>
                        <div class="user-info">
                            <button class="btn btn-danger" onclick="cancelarPaseLista()">‚Üê Volver</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è IMPORTANTE:</strong> Selecciona el tipo de encuentro antes de pasar lista
                        </div>
                        
                        ${configuracion.permitirEditarCentros ? `
                            <div class="alert alert-info">
                                <strong>‚úèÔ∏è Edici√≥n habilitada:</strong> Puedes editar el centro educativo de cada participante
                            </div>
                        ` : ''}
                        
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">üìÖ Fecha de hoy</div>
                            <div style="font-size: 1.5rem; font-weight: 700; text-transform: capitalize;">${fechaFormateada}</div>
                        </div>
                        <input type="hidden" id="fechaAsistencia" value="${fechaHoy}">
                        
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="tipoPresencial" name="tipoEncuentro" value="presencial" checked onchange="cambiarTipoEncuentro('presencial')">
                                <label for="tipoPresencial">üè´ PRESENCIAL</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="tipoVirtual" name="tipoEncuentro" value="virtual" onchange="cambiarTipoEncuentro('virtual')">
                                <label for="tipoVirtual">üíª VIRTUAL</label>
                            </div>
                        </div>
                        
                        ${misParticipantes.length === 0 ? 
                            '<div class="alert alert-warning">No hay participantes en este grupo.</div>' :
                            `
                            <div class="alert alert-info">
                                Total: <strong>${misParticipantes.length}</strong> | 
                                Presentes: <strong id="contadorPresentes">0</strong> | 
                                Ausentes: <strong id="contadorAusentes">0</strong>
                            </div>
                            
                            <div class="attendance-grid">
                                ${misParticipantes.map((p, index) => {
                                    const asist = asistenciaTemporal[p.id] || { presente: false, ausente: false };
                                    return `
                                        <div class="attendance-row">
                                            <div class="attendance-number">${index + 1}</div>
                                            <div>
                                                <div class="participant-info">${p.nombre} ${p.apellido}</div>
                                                ${configuracion.permitirEditarCentros ? `
                                                    <input type="text" 
                                                           value="${p.centro}" 
                                                           onblur="actualizarCentroEducativo('${p.id}', this.value)"
                                                           style="font-size: 0.85rem; padding: 0.25rem 0.5rem; margin-top: 0.25rem; border: 1px solid #E8E8F0; border-radius: 4px; width: 100%;"
                                                           placeholder="Centro educativo">
                                                ` : `
                                                    <div class="participant-center">${p.centro}</div>
                                                `}
                                            </div>
                                            <div class="checkbox-toggle">
                                                <label>
                                                    <input type="checkbox" class="presente-check" data-id="${p.id}"
                                                           ${asist.presente ? 'checked' : ''}
                                                           onchange="toggleAsistenciaTemporal('${p.id}', 'presente'); renderCheckboxes();">
                                                    ‚úì Presente
                                                </label>
                                            </div>
                                            <div class="checkbox-toggle">
                                                <label>
                                                    <input type="checkbox" class="ausente-check" data-id="${p.id}"
                                                           ${asist.ausente ? 'checked' : ''}
                                                           onchange="toggleAsistenciaTemporal('${p.id}', 'ausente'); renderCheckboxes();">
                                                    ‚úó Ausente
                                                </label>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <div class="save-container">
                                <button class="btn btn-success" onclick="guardarAsistencia()">
                                    üíæ Guardar Asistencia
                                </button>
                            </div>
                            `
                        }
                    </div>
                </div>
            `;
        }

        function renderVisualizadorDashboard() {
            return `
                <div class="container dashboard">
                    <div class="dashboard-header">
                        <div>
                            <h2>Panel de Consulta</h2>
                            <p class="text-gray">${currentUser.nombre}</p>
                        </div>
                        <div class="user-info">
                            <span class="user-badge">üëÅÔ∏è Visualizador</span>
                            <button class="btn btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        ${renderAsistenciasAdminTab()}
                    </div>
                </div>
            `;
        }

        // ==================== EVENT HANDLERS ====================
        function attachLoginHandlers() {
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                login(document.getElementById('usuario').value, document.getElementById('password').value);
            });
        }

        function attachAdminHandlers() {
            const crearGrupoForm = document.getElementById('crearGrupoForm');
            if (crearGrupoForm) {
                crearGrupoForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const distrito = document.getElementById('distritoGrupo').value;
                    const nombre = document.getElementById('nombreGrupo').value;
                    await crearGrupo(distrito, nombre);
                    this.reset();
                });
            }

            const cargarExcelForm = document.getElementById('cargarExcelForm');
            if (cargarExcelForm) {
                const fileUpload = document.getElementById('fileUpload');
                const fileInput = document.getElementById('excelFile');

                fileUpload.addEventListener('click', () => fileInput.click());

                cargarExcelForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const distrito = document.getElementById('distritoExcel').value;
                    const grupoId = document.getElementById('grupoExcel').value;
                    const file = fileInput.files[0];

                    if (!distrito || !grupoId || !file) {
                        mostrarAlerta('Por favor completa todos los campos', 'warning');
                        return;
                    }

                    procesarExcel(file, distrito, grupoId);
                    this.reset();
                });
            }

            const formCrearUsuario = document.getElementById('formCrearUsuario');
            if (formCrearUsuario) {
                formCrearUsuario.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Deshabilitar bot√≥n para evitar doble click
                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn.disabled) return;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creando...';
                    
                    try {
                        await crearUsuario(
                            document.getElementById('nombreUsuario').value,
                            document.getElementById('usuarioLogin').value,
                            document.getElementById('passwordUsuario').value
                        );
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Crear Usuario';
                    }
                });
            }

            const formAsignarRol = document.getElementById('formAsignarRol');
            if (formAsignarRol) {
                formAsignarRol.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const usuarioId = document.getElementById('selectUsuario').value;
                    const rol = document.getElementById('selectRol').value;

                    let asignaciones = [];
                    if (rol === 'docente') {
                        const asignacionDivs = document.querySelectorAll('[id^="asignacion-"]');
                        asignacionDivs.forEach(div => {
                            const grupoId = div.querySelector('.asignacion-grupo').value;
                            const asignatura = div.querySelector('.asignacion-asignatura').value;
                            if (grupoId && asignatura) {
                                asignaciones.push({ grupoId, asignatura });
                            }
                        });
                    }

                    await asignarRol(usuarioId, rol, asignaciones);
                    this.reset();
                    document.getElementById('asignacionesContainer').innerHTML = '';
                    contadorAsignaciones = 0;
                });
            }

            const formEditarUsuario = document.getElementById('formEditarUsuario');
            if (formEditarUsuario) {
                formEditarUsuario.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const usuarioId = document.getElementById('editUsuarioId').value;
                    const nombre = document.getElementById('editNombreUsuario').value;
                    const usuario = document.getElementById('editUsuarioLogin').value;
                    const password = document.getElementById('editPasswordUsuario').value;
                    
                    await editarUsuario(usuarioId, nombre, usuario, password);
                });
            }

            actualizarSelectUsuarios();
        }

        function attachPaseListaHandlers() {
            actualizarContadores();
        }

        function actualizarGruposExcel() {
            const distrito = document.getElementById('distritoExcel').value;
            const grupoSelect = document.getElementById('grupoExcel');
            const gruposDistrito = grupos.filter(g => g.distrito === distrito);

            if (gruposDistrito.length === 0) {
                grupoSelect.innerHTML = '<option value="">No hay grupos en este distrito</option>';
            } else {
                grupoSelect.innerHTML = '<option value="">Selecciona un grupo</option>' +
                    gruposDistrito.map(g => `<option value="${g.id}">${g.nombre}</option>`).join('');
            }
        }

        // ==================== INICIALIZACI√ìN ====================
        window.onload = function() {
            if (firebaseConfigured) {
                cargarDatos();
            } else {
                render();
            }
        };
    </script>
</body>
</html>
